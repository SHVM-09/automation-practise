name: 'Deploy - Laravel Demos'

on:
  workflow_dispatch:
    inputs:
      is_production:
        type: boolean
        description: Is production deployment

jobs:
  deployment:
    runs-on: ubuntu-latest
    env:
      DEPLOY_DIR: ${{ inputs.is_production && secrets.PROD_DIR || secrets.STAG_DIR }}
      TEMPLATE_NAME: materio
    steps:
      - run: echo $(${{ inputs.is_production }} && echo "Deploying production" || echo "Deploying staging")

      - name: Clone current repo under /<template-name>/vue-laravel
        uses: actions/checkout@v3
        with:
          path: ${{ env.TEMPLATE_NAME }}/vue-laravel

      - name: Clone automation scripts repo under /automation-scripts
        uses: actions/checkout@v3
        with:
          repository: themeselection/automation-scripts
          token: ${{ secrets.GH_PAT }}
          path: automation-scripts
      
      - name: Install packages in automation-scripts dir
        working-directory: automation-scripts/vue
        run: yarn

      - name: Install packages in typescript full version
        working-directory: ${{ env.TEMPLATE_NAME }}/vue-laravel/typescript-version/full-version
        run: yarn && composer install
        
      - name: Create .env file from .env.example & generate APP_KEY via php artisan key:generate
        working-directory: ${{ env.TEMPLATE_NAME }}/vue-laravel/typescript-version/full-version
        run: cp .env.example .env && php artisan key:generate

      - name: Generate demos
        working-directory: automation-scripts/vue
        run: yarn tsx src/templates/${{ env.TEMPLATE_NAME }}/scripts/genLaravelDemos.ts $([[ "${{ inputs.is_production }}" != "true" ]] && echo --staging)

      - name: Upload demos zip
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SSHKEY }}
          source: ${{ env.TEMPLATE_NAME }}/vue-laravel/typescript-version/full-version/*.zip
          target: ${{ secrets.LARAVEL_CORE_CONTAINER_DIR }}
          strip_components: 4

      # - name: Cleanup demos
      #   uses: appleboy/ssh-action@v0.1.5
      #   with:
      #     host: ${{ secrets.HOST }}
      #     username: ${{ secrets.USERNAME }}
      #     port: ${{ secrets.PORT }}
      #     key: ${{ secrets.SSHKEY }}
      #     script: |
      #       cd ${{ env.DEPLOY_DIR }}
      #       rm -rf demos-backup-*.zip
      #       DEMO_ZIP_NAME="demos-backup-$(date +"%Y-%m-%d-%H-%M-%S").zip"
      #       [[ "${{ inputs.is_production }}" == "true" ]] && rm -rf ${{ secrets.STAG_DIR }}/demo-* && zip -r $DEMO_ZIP_NAME demo-*
      #       rm -rf demo-*
